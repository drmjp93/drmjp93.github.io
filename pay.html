<!-- START: Payment card -->
<section style="max-width:720px;margin:18px auto;padding:18px;border-radius:12px;background:#fff;border:1px solid #eee;">
  <!-- Top: back -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <a href="telemedicine.html" style="padding:8px 12px;border-radius:8px;background:#f3f4f6;color:#111;text-decoration:none;border:1px solid #e6e6e6;">← Back</a>
    <strong style="font-size:1rem">Pay for Telemedicine</strong>
    <div style="width:48px"></div>
  </div>

  <!-- UPI display -->
  <div style="display:flex;gap:14px;align-items:center;padding:14px;border-radius:10px;background:#f8fafc;border:1px solid #eef6fb;">
    <div style="flex:1">
      <div style="font-size:0.95rem;color:#444;font-weight:800;margin-bottom:6px;">Payee</div>
      <div style="font-family:monospace;font-size:1.05rem;color:#06233a;">Mit J Panchani</div>
      <div style="font-size:0.88rem;color:#6b7280;margin-top:8px;">UPI ID</div>
      <div id="upiID" style="font-family:monospace;font-size:1.05rem;color:#06233a;margin-top:3px;">drmjp93@upi</div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;min-width:160px;">
      <button id="copyUpi" style="padding:10px;border-radius:8px;border:none;background:#0366d6;color:#fff;cursor:pointer;">Copy UPI</button>
      <a id="genericUpi" class="btn" style="display:inline-block;padding:10px;border-radius:8px;text-align:center;background:#0b7285;color:#fff;text-decoration:none;">Open UPI app</a>
    </div>
  </div>

  <!-- App-specific row -->
  <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
    <!-- Generic UPI above covers most apps. App-specific intents below (Android): -->
    <a id="gpayBtn" href="#" style="padding:8px 10px;border-radius:8px;background:#0f7ded;color:#fff;text-decoration:none;">Open Google Pay</a>
    <a id="phonepeBtn" href="#" style="padding:8px 10px;border-radius:8px;background:#0b6b3a;color:#fff;text-decoration:none;">Open PhonePe</a>
    <a id="bhimBtn" href="#" style="padding:8px 10px;border-radius:8px;background:#111;color:#fff;text-decoration:none;">Open BHIM</a>
    <!-- <a id="waBtn" href="#" style="padding:8px 10px;border-radius:8px;background:#25D366;color:#fff;text-decoration:none;">Send to WhatsApp</a> -->
  </div>

  <!-- Amount -->
  <div style="margin-top:12px;">
    <label style="font-weight:700;display:block;margin-bottom:6px;">Amount (₹)</label>
    <input id="amount" type="number" value="400" min="1" style="padding:10px;border-radius:8px;border:1px solid #ddd;width:140px">
  </div>

  <!-- Txn ID input -->
  <div style="margin-top:12px;">
    <label style="font-weight:700;display:block;margin-bottom:6px;">After payment — paste UPI Transaction ID</label>
    <input id="txnId" placeholder="Example: 123456789012" style="padding:10px;border-radius:8px;border:1px solid #ddd;width:100%;max-width:420px;">
    <div style="display:flex;gap:10px;margin-top:10px;max-width:420px;">
      <button id="submitTxn" style="padding:10px;border-radius:8px;border:none;background:#0366d6;color:#fff;cursor:pointer;">Submit Txn ID</button>
      <button id="clearTxn" style="padding:10px;border-radius:8px;border:none;background:#aaa;color:#fff;cursor:pointer;">Clear</button>
    </div>
    <div id="txnMsg" style="margin-top:8px;color:#666;font-size:0.95rem;"></div>
  </div>
</section>

<script>
/*
  pay.html payment card script
  - configure UPI_ID & PAYEE_NAME below
  - generic upi deep-link opens most UPI apps
  - app-specific "intent" links are provided for Android; they may or may not open depending on browser/platform
  - Txn ID submit behaves:
      • tries POST to /verify-upi
      • if server not present, saves submitted txns in localStorage for staff manual check
*/

const UPI_ID = 'drmjp93@upi';
const PAYEE_NAME = 'Mit J Panchani';
const DEFAULT_NOTE = 'Telemedicine Consultation';

function encode(v){ return encodeURIComponent(v); }
function buildUpiLink(amount){
  // amount should be plain number
  const am = Number(amount).toFixed(2);
  return `upi://pay?pa=${encode(UPI_ID)}&pn=${encode(PAYEE_NAME)}&am=${encode(am)}&tn=${encode(DEFAULT_NOTE)}&cu=INR`;
}

// set UI links on page load / when amount changes
function refreshLinks(){
  const amount = document.getElementById('amount').value || '0';
  const upi = buildUpiLink(amount);
  document.getElementById('genericUpi').href = upi;

  // App-specific intent URIs (Android). These attempt to open the app directly.
  // They are best-effort — browsers or iOS may not support.
  document.getElementById('gpayBtn').href = `intent://${upi.replace('upi://','')}#Intent;package=com.google.android.apps.nbu.paisa.user;scheme=upi;end`;
  document.getElementById('phonepeBtn').href = `intent://${upi.replace('upi://','')}#Intent;package=com.phonepe.app;scheme=upi;end`;
  document.getElementById('bhimBtn').href = `intent://${upi.replace('upi://','')}#Intent;package=in.org.npci.upiapp;scheme=upi;end`;

  // copy button label remains same
}

// copy UPI to clipboard
document.getElementById('copyUpi').addEventListener('click', async ()=>{
  try {
    await navigator.clipboard.writeText(UPI_ID);
    alert('UPI ID copied to clipboard. Paste in your UPI app.');
  } catch(e){
    const ta = document.createElement('textarea'); ta.value = UPI_ID; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); ta.remove();
    alert('Copied UPI ID.');
  }
});

// Txn ID submit
document.getElementById('submitTxn').addEventListener('click', async ()=>{
  const txn = document.getElementById('txnId').value.trim();
  const amount = document.getElementById('amount').value || '0';
  const msgEl = document.getElementById('txnMsg');
  if(!txn){ msgEl.style.color = '#9b1b1b'; msgEl.innerText = 'Enter Transaction ID before submit.'; return; }
  msgEl.style.color = '#666'; msgEl.innerText = 'Verifying...';

  try {
    const res = await fetch('/verify-upi', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ txn, amount, upi: UPI_ID })
    });

    if(res.ok){
      const j = await res.json();
      if(j.ok){
        msgEl.style.color = '#0b6b2d';
        msgEl.innerText = 'Payment verified ✅ Booking confirmed.';
      } else {
        msgEl.style.color = '#9b1b1b';
        msgEl.innerText = 'Not verified: ' + (j.msg || 'pending');
      }
      return;
    }
  } catch(e){
    // fallthrough to local-store fallback
  }

  // fallback when /verify-upi not available: store locally for staff verification
  try {
    const pending = JSON.parse(localStorage.getItem('pendingUpiTxns')||'[]');
    pending.push({ txn, amount, upi:UPI_ID, when: new Date().toISOString()});
    localStorage.setItem('pendingUpiTxns', JSON.stringify(pending));
    msgEl.style.color = '#0b6b2d';
    msgEl.innerText = 'Saved locally for manual verification. Staff will check bank. (No server configured)';
  } catch(err){
    msgEl.style.color = '#9b1b1b';
    msgEl.innerText = 'Could not save locally. Please inform staff.';
  }
});

// clear txn
document.getElementById('clearTxn').addEventListener('click', ()=>{
  document.getElementById('txnId').value='';
  document.getElementById('txnMsg').innerText='';
});

// amount change updates links
document.getElementById('amount').addEventListener('input', refreshLinks);

// init
refreshLinks();
</script>
<!-- END: Payment card -->
